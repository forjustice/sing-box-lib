name: Release

on:
  workflow_dispatch:
  repository_dispatch:
    types: [release]
  # push:
  #   paths:
  #     - version

jobs:
  # --- Job 1: Build Apple xcframework on macOS ---
  build_apple:
    runs-on: macOS-15
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      checksum: ${{ steps.checksum.outputs.checksum }}

    steps:
      - uses: actions/checkout@v4

      - name: Get Sing-Box version
        id: version
        run: |
          if [ -f version ]; then
            tag=$(cat version)
            echo "tag=${tag}" >> $GITHUB_ENV
            echo "tag=${tag}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        with:
          repository: SagerNet/sing-box
          path: box
          ref: ${{ env.tag }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: false

      - name: Setup Gomobile
        run: |
          cd box
          make lib_install
          export PATH="$PATH:$(go env GOPATH)/bin"
          gomobile init

      - name: Build xcframework
        run: |
          cd box
          export PATH="$PATH:$(go env GOPATH)/bin"
          go run ./cmd/internal/build_libbox -target apple -platform ios,iossimulator,tvos,tvossimulator,macos
          zip -ry ./Libbox.xcframework.zip ./Libbox.xcframework

      - name: Detect checksum
        id: checksum
        run: |
          CHECKSUM=$(shasum -a 256 box/Libbox.xcframework.zip | awk '{print $1}')
          echo "checksum=$CHECKSUM" >> $GITHUB_OUTPUT

      - name: Upload xcframework artifact
        uses: actions/upload-artifact@v4
        with:
          name: Libbox.xcframework.zip
          path: box/Libbox.xcframework.zip

  # --- Job 2: Build Android aar on Ubuntu ---
  build_android:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Get Sing-Box version
        run: |
          if [ -f version ]; then
            tag=$(cat version)
            echo "tag=${tag}" >> $GITHUB_ENV
          fi

      - uses: actions/checkout@v4
        with:
          repository: SagerNet/sing-box
          path: box
          ref: ${{ env.tag }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: false

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r28
          local-cache: true

      - name: Setup OpenJDK
        run: |
          sudo apt update && sudo apt install -y openjdk-17-jdk-headless
          /usr/lib/jvm/java-17-openjdk-amd64/bin/java --version

      - name: Build Android aar
        run: |
          cd box
          make lib_install
          export PATH="$PATH:$(go env GOPATH)/bin"
          make lib_android
        env:
          JAVA_HOME: /usr/lib/jvm/java-17-openjdk-amd64
          ANDROID_NDK_HOME: ${{ steps.setup-ndk.outputs.ndk-path }}

      - name: Upload Android aar artifact
        uses: actions/upload-artifact@v4
        with:
          name: libbox.aar
          path: box/libbox.aar

  # --- Job 3: Release - depends on both builds ---
  release:
    runs-on: ubuntu-latest
    needs: [build_apple, build_android]
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version
        run: |
          if [ -f version ]; then
            tag=$(cat version)
            echo "tag=${tag}" >> $GITHUB_ENV
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Prepare release files
        run: |
          # Move files to temp names first to avoid directory name conflict
          mv dist/Libbox.xcframework.zip/Libbox.xcframework.zip dist/xcframework_temp.zip
          mv dist/libbox.aar/libbox.aar dist/aar_temp.aar
          # Remove the artifact directories
          rm -rf dist/Libbox.xcframework.zip dist/libbox.aar
          # Rename to final names
          mv dist/xcframework_temp.zip dist/Libbox.xcframework.zip
          mv dist/aar_temp.aar dist/libbox.aar
          ls -la dist/

      - name: Update Package.swift
        run: |
          CHECKSUM="${{ needs.build_apple.outputs.checksum }}"
          cat > Package.swift << EOF
          // swift-tools-version: 5.7

          import PackageDescription

          let package = Package(
            name: "Libbox",
            platforms: [.iOS(.v12)],
            products: [
              .library(name: "Libbox", targets: ["Libbox"]),
            ],
            targets: [
              .binaryTarget(
                name: "Libbox",
                url: "https://github.com/liujixings/sing-box-lib/releases/download/${{ env.tag }}/Libbox.xcframework.zip",
                checksum: "$CHECKSUM"
              )
            ]
          )
          EOF

      - name: Commit manifest & tag
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Libbox Release ${{ env.tag }}"
          commit_user_name: "liujixings"
          commit_user_email: "liujixings@outlook.com"
          tagging_message: "${{ env.tag }}"
          file_pattern: Package.swift

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        with:
          draft: false
          tag_name: ${{ env.tag }}
          body: "Compiled from source tag: ${{ env.tag }}"
          files: |
            dist/Libbox.xcframework.zip
            dist/libbox.aar
